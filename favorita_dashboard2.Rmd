---
title: "Favorita"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    source_code: embed
---


```{r global, include=FALSE}
# load data in 'global' chunk so it can be shared
#  by all users of the dashboard
###
library(flexdashboard)
library(shiny)
library(ggplot2)     # graphing
library(dplyr)       # data summarization and manipulation
library(tidyr)       # reshaping data frame
library(lubridate)   # date conversion and manipulation
library(wordcloud2)  # html widget for wordcloud
library(DT)          # html widget for table
library(data.table)  # fast file reading using data.table::fread
library(highcharter) # html widget for charting

setwd('./')          #default to source file directory
items.df        = fread('./data/items.csv',stringsAsFactors = T)
oil.df          = fread('./data/oil_2013.csv', stringsAsFactors = T)
stores.df       = fread('./data/stores.csv', stringsAsFactors = T)
transactions.df = fread('./data/transactions_2013.csv', stringsAsFactors = T)
holidays.df     = fread('./data/holidays_2013.csv', stringsAsFactors = T)
train.df        = fread('./data/train_2013.csv', stringsAsFactors = T, colClasses = c(date='Date'))

### data preparation for Stores chapter - vikas
###
states.code.df   = fread('./data/state-postalcode.csv', stringsAsFactors = T)
city.location.df = fread('./data/city.lon.csv', stringsAsFactors = T)

stores.by.state = 
  stores.df %>% count(state) %>%
  left_join(states.code.df, by="state")

state.transactions =
  transactions.df %>% 
  left_join(stores.df, by = "store_nbr") %>% 
  group_by(state) %>% 
  summarize( 
    n_trans = sum(transactions)
    ) %>%
  left_join(states.code.df, by="state")

### data preparation for Items - yong
###
states.summary = stores.df %>% group_by(state) %>% 
  mutate(cities=paste(unique(city), collapse = " - ")) %>% 
  summarize(n_stores=n(), n_cities=n_distinct(city), cities=max(cities)) %>% 
  left_join(state.transactions) %>%
  arrange(-n_stores)

family.freq = items.df %>% count(family) %>% arrange(desc(n))
item.trans = train.df %>% group_by(item_nbr) %>% summarize(trans=n())
items.df = left_join(items.df, item.trans) %>% select(item_nbr, family, trans)

## data preparatino for Forecast - SL
#train_set.df = fread('./data/train_set_2013.csv', stringsAsFactors = T)
#train_set.df$date = ymd(train_set.df$date)
load(file='data/coefs') # linear model coefs for prediction
```


# Introduction {data-orientation=rows}

## Row 1 {data-height="22%"}

### Logo {.no-title data-width=80}

![](img/favorita_logo.jpg)


### ABOUT FAVORITA
    
```{r about}
HTML("<p>Corporacion Favorita is an Ecuadorian services and commerce company based in City of Quito, Ecador. It is among the <span style='color:blue'>three largest </span>companies in the country. Its business concept is mainly <span style='color:blue'>self-service store where food, basic necessities</span> and others are offered.</p>")

HTML("<p>It has been a challenge for Favorita in inventory stocking. Favorita had raised a competition to help <span style='color:red'>develop model to predict item sales </span> based on historical data.</p>")
```

## Row 2 {data-height="1%" .no-title}

### DATASETS

```{r dataset}
p("Five years observations had been provided (2013-2017). Due to the limitation of computer memory, our analysis and model will be based on year 2013")
```

## Row 3 {data-height="77%"}

### Stores {.no-title}

```{r stores}
h4("Stores")
p("All stores")
hr()
h5(paste("Columns:  ", ncol(stores.df)))
h5(paste("Rows: ", nrow(stores.df)))
h5(paste("Incomplete Cases: ",sum(!complete.cases(stores.df))))
hr()
h5("Variables: ")
tags$ul(lapply(names(stores.df),function(x) tags$li(x)))
```

### Items {.no-title}

```{r items}
h4("Items")
p("Items being sold in category")
hr()
h5(paste("Columns:  ", ncol(items.df)))
h5(paste("Rows: ", nrow(items.df)))
h5(paste("Incomplete Cases: ",sum(!complete.cases(items.df))))
hr()
h5("Variables: ")
tags$ul(lapply(names(items.df),function(x) tags$li(x)))
```

### Transactions {.no-title}

```{r transactions}
h4("Transactions")
p("Total item transactions for each store")
hr()
h5(paste("Columns:  ", ncol(transactions.df)))
h5(paste("Rows: ", nrow(transactions.df)))
h5(paste("Incomplete Cases: ",sum(!complete.cases(transactions.df))))
hr()
h5("Variables: ")
tags$ul(lapply(names(transactions.df),function(x) tags$li(x)))
```

### Holidays  {.no-title}

```{r holidays}
h4("Holidays")
p("Holidays date and type")
hr()
h5(paste("Columns:  ", ncol(holidays.df)))
h5(paste("Rows: ", nrow(holidays.df)))
h5(paste("Incomplete Cases: ",sum(!complete.cases(holidays.df))))
hr()
h5("Variables: ")
tags$ul(lapply(names(holidays.df),function(x) tags$li(x)))
```

### Oil {.no-title}

```{r oil}
h4("Oil")
p("Daily oil price. Ecuador is fully importer of oil. Its economy is affect by oil price")
hr()
h5(paste("Columns:  ", ncol(oil.df)))
h5(paste("Rows: ", nrow(oil.df)))
h5(paste("Incomplete Cases: ",sum(!complete.cases(oil.df))))
hr()
h5("Variables: ")
tags$ul(lapply(names(oil.df),function(x) tags$li(x)))
```

### Train {.no-title}

```{r train}
h4("Train")
p("Daily detail transaction by item sales for for all stores")
hr()
h5(paste("Columns:  ", ncol(train.df)))
h5(paste("Rows: ", nrow(train.df)))
h5(paste("Incomplete Cases: ",sum(!complete.cases(train.df))))
hr()
h5("Variables: ")
tags$ul(lapply(names(train.df),function(x) tags$li(x)))
```

# Items {data-orientation=columns}

## Column 1 - Table {data-width="30%"}

### Total Families / Items

```{r families-valuebox}
flexdashboard::renderValueBox({
  total_families = length(unique(items.df$family))
  total_items = nrow(items.df)
  value_text = paste(total_families, total_items, sep = " / ")
  flexdashboard::valueBox( value=value_text, icon = "fa-bar-chart", color='info')
})
```

### Family List

```{r families-table}
DT::dataTableOutput("families")
output$families =
  DT::renderDataTable({
    df = family.freq
    DT::datatable(df,
                  options = list(
                    bPaginate = FALSE,
                    scrollY = "65vh"
                  ))
  })
```

## Column 2 - Word Cloud {data-width="30%"}

### Word Cloud {.no-title}

```{r wordcloud}
renderWordcloud2({
  wordcloud2(family.freq, size=0.4, rotateRatio=1, minRotation = -pi/6, maxRotation = -pi/6 )
})
```


### Item List

```{r item-table}
DT::dataTableOutput("items")
output$items =
  DT::renderDataTable({
    selected_families = family.freq$family[input$families_rows_selected]
    if (length(selected_families)==0)
      df = items.df
    else
      df = items.df %>% filter (family %in% selected_families)
    DT::datatable(df,
                  options = list(
                    bPaginate = FALSE,
                    scrollY = "40vh",
                    dom = 't'
                  ))
  })
```

## Column 3 - Bar Chart {data-width="40%"}

### Items Distribution {.no-title}

```{r items-distribution-chart}
renderPlot({
#  family.freq = items.df %>% count(family) %>% arrange(desc(n))
  selected_families = family.freq$family[input$families_rows_selected]
  df = family.freq %>% 
        mutate (to_highlight = ifelse (family %in% selected_families, "yes", "no"))
  ggplot(df, aes(x=reorder(family,-n), y=n, fill = to_highlight)) + geom_bar(stat='identity') +  
  labs(title='Items Distribution', x='Family', y='Number of Items') +
  scale_fill_manual( values = c( "yes"="tomato", "no"="gray" ), guide = FALSE ) +
  theme(axis.text.x  = element_text (angle = (90), hjust = 1, vjust = 0.5))
})

```

# Trasnsactions {data-orientation=rows}

## Row 1 {data-height="50%"}

### Transactions vs Oil Price

```{r oil-prices}
trans.df <- transactions.df %>%
  mutate(date = ymd(date),
         store_nbr = as.factor(store_nbr))

oiltrans.df <- oil.df %>%
  mutate(date = ymd(date))

foo <- trans.df %>%
  group_by(date) %>%
  summarise(trans = sum(transactions))

oil_back <- oiltrans.df %>%
    filter(date > min(foo$date))

oil_back <- oil_back %>%
    mutate(oilprice = ( min(foo$trans, na.rm = TRUE) +
      (dcoilwtico-min(dcoilwtico, na.rm = TRUE))/(max(dcoilwtico, na.rm = TRUE) - min(dcoilwtico, na.rm = TRUE)) *
        (max(foo$trans, na.rm = TRUE) - min(foo$trans, na.rm = TRUE)) ))

renderPlot({
foo %>%
  ggplot(aes(date, trans)) +
  geom_line() +
  geom_line(data = oil_back, aes(date, oilprice), color = "blue") +
  ggtitle("Total transactions (black) with oilprice (blue)") +
  theme(axis.text=element_text(size=16),
        axis.title=element_text(size=18,face="bold"))
})
```

## Row 2 {data-height="50%" .no-title}

### Monthly Transactions

```{r monthly-trans}
#rename transactions.df
merge_trans <- transactions.df

#Format training data
merge_trans <- merge_trans %>% 
  mutate(
    date = ymd(date),
    store_nbr = as.factor(store_nbr),
    weekday = wday(as.Date(date,'%y-%m-%d')),
    weekday = as.factor(weekday)
  )

#separate 'date' to c(year, month, day)
merge_trans <- merge_trans %>% separate(date, c("year", "month", "day"))

#select variables for merge_trans
merge_trans <- merge_trans %>%
  select(transactions, year, month, day, store_nbr, weekday)

#plot transactions over time
renderPlot({
merge_trans %>% ggplot(aes(month, transactions, fill = month)) +
  geom_boxplot() + 
  ggtitle("Boxplots of Transactions by Month") +
  theme(axis.text=element_text(size=16),
        axis.title=element_text(size=18,face="bold"),
        legend.position="none")
})
```

### Weekly Transactions

```{r weekly-trans}
#transactions over weekday
renderPlot({
  merge_trans %>% 
    ggplot(aes(weekday, transactions, fill = weekday)) +
    geom_boxplot() +
    ggtitle("Boxplots of Transactions by Day") +
    theme(axis.text=element_text(size=16),
          axis.title=element_text(size=18,face="bold"),
          legend.position="none")
})
```


# Stores {data-orientation=columns}

## Column 1 

### Total States / Stores

```{r stores-valuebox}
flexdashboard::renderValueBox({
  total_states = nrow(states.summary)
  total_stores = nrow(stores.df)
  value_text = paste(total_states, total_stores, sep = " / ")
  flexdashboard::valueBox( value=value_text, icon = "fa-bar-chart", color='orange')
})

```

### Stores Table {.no-title}

```{r stores-table}
DT::renderDataTable({
  DT::datatable(states.summary[,c('state','n_trans','n_stores','n_cities','cities')], 
                options = list(
                bPaginate = FALSE, scrollY="65vh"
  ))
})
``` 


## Column 2 {.tabset}

### Transactions by State

```{r state-trans}
label_data_trans <- transactions.df %>% group_by(store_nbr) %>% summarize(total = sum(transactions)) %>% as.data.frame()
label_data_trans$store_name = paste('Store ', label_data_trans$store_nbr )
label_data_trans <- label_data_trans %>% left_join(stores.df, by = "store_nbr")

empty_bar=1
to_add = data.frame( matrix(NA, empty_bar*nlevels(label_data_trans$state), ncol(label_data_trans)) )
colnames(to_add) = colnames(label_data_trans)
to_add$state=rep(levels(label_data_trans$state), each=empty_bar)
label_data_trans=rbind(label_data_trans, to_add)

label_data_trans=label_data_trans %>% arrange(state, total)
label_data_trans$id=seq(1, nrow(label_data_trans))

number_of_bar=nrow(label_data_trans)
angle= 180 - 360 * (label_data_trans$id-0.5) /number_of_bar

label_data_trans$hjust<-ifelse( angle < -90, 1, ifelse( angle >90, 1,0))
label_data_trans$angle<-ifelse(angle < -90, angle+180, ifelse( angle >90, angle+180,angle))

# prepare a data frame for base lines
base_data=label_data_trans %>% 
  group_by(state) %>% 
  summarize(start=min(id), end=max(id) - empty_bar) %>% 
  rowwise() %>% 
  mutate(title=mean(c(start, end)))

p = ggplot(label_data_trans, aes(x=as.factor(id), y=total, fill=state)) +     
  geom_bar(aes(x=as.factor(id), y=total, fill=state), stat="identity", alpha=0.5) +
  ylim(-300000,1500000) +
  theme_minimal() +
  theme(
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    legend.position = "right",
    legend.text = element_text(size=4),
    #legend.key.size = 1,
    plot.margin = unit(rep(-1,4), "cm")
  )+
  coord_polar(start = 50000) +
  geom_text(data=label_data_trans, aes(x=id, y=total, label=store_name, hjust=hjust), color="black", fontface="bold",alpha=0.6, size=2, angle= label_data_trans$angle, inherit.aes = FALSE ) +
    # Add base line information
  geom_segment(data=base_data, aes(x = start, y = -50000, xend = end, yend = -50000), colour = "black", alpha=0.8, size=0.5 , inherit.aes = FALSE )  

p
```

### Transactions by Volume

```{r trans-volume}
label_data_trans <- transactions.df %>% group_by(store_nbr) %>% summarize(total = sum(transactions)) %>% as.data.frame()
label_data_trans$store_name = paste('Store ', label_data_trans$store_nbr )
label_data_trans <- label_data_trans %>% left_join(stores.df, by = "store_nbr")
#label_data_trans

label_data_trans=label_data_trans %>% arrange(total)
label_data_trans$id=seq(1, nrow(label_data_trans))
#label_data_trans

number_of_bar=nrow(label_data_trans)
angle= 180 - 360 * (label_data_trans$id-0.5) /number_of_bar

label_data_trans$hjust<-ifelse( angle < -90, 1, ifelse( angle >90, 1,0))
label_data_trans$angle<-ifelse(angle < -90, angle+180, ifelse( angle >90, angle+180,angle))
#label_data_trans

# prepare a data frame for base lines
base_data=label_data_trans %>% 
  group_by(state) %>% 
  summarize(start=min(id), end=max(id) - empty_bar) %>% 
  rowwise() %>% 
  mutate(title=mean(c(start, end)))

#base_data

p=ggplot(label_data_trans, aes(x=as.factor(id), y=total, fill=state)) +     
  geom_bar(aes(x=as.factor(id), y=total, fill=state), stat="identity", alpha=0.5) +
  ylim(-300000,1500000) +
  theme_minimal() +
  theme(
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    legend.position = "right",
    legend.text = element_text(size=4),
    #legend.key.size = 1,
    plot.margin = unit(rep(-1,4), "cm")
  )+
  coord_polar(start = 50000) +
  geom_text(data=label_data_trans, aes(x=id, y=total, label=store_name, hjust=hjust), color="black", fontface="bold",alpha=0.6, size=2, angle= label_data_trans$angle, inherit.aes = FALSE ) 

p
```
    

### Stores Map

```{r stores-map}
renderHighchart({
hcmap("https://code.highcharts.com/mapdata/countries/ec/ec-all", 
      data = stores.by.state, 
      value = "n",
      joinBy = c("postal-code", "postalcode"), 
      name = "Total Stores",
      dataLabels = list(enabled = TRUE, format = '{point.name}'),
      borderColor = "#000000", borderWidth = 0.2,
      tooltip = list(valueDecimals = 0)) %>%
  #hc_colorAxis(stops = colstops) %>%
  hc_mapNavigation(enabled = TRUE) %>%
  hc_legend(title=list(text="Total Stores"))
})
```

### Transactions Map

```{r trans-map}
city.location.df$color = 'red'
renderHighchart({
  hcmap("https://code.highcharts.com/mapdata/countries/ec/ec-all", 
      data = state.transactions, 
      value = "n_trans",
      joinBy = c("postal-code", "postalcode"), name = "Total Transactions",
      dataLabels = list(enabled = TRUE, format = '{point.name}'),
      borderColor = "#000000", borderWidth = 0.2,
      tooltip = list(valueDecimals = 0)) %>%
    #hc_colorAxis(stops = colstops) %>%
    hc_add_series(data = city.location.df, type = "mapbubble", name = "Stores in City", maxSize = '10%') %>% 
    hc_mapNavigation(enabled = TRUE) %>%
    hc_legend(title=list(text="Total Transactions"))
})
```


# Forecast {data-orientation=columns}

```{r build-prediction}
predicted.df = reactive({
  # return NULL if date from is > date to
  if (input$date_range[1] < input$date_range[2]) {
    dates_vector = seq(as.Date(input$date_range[1]),as.Date(input$date_range[2]),by='days')
    df = data.frame(
      store_nbr = as.integer(input$select_store),
      item_nbr = as.integer(input$select_item),
      date     = dates_vector
    )
    df$total_sales = 
      coefs['store_nbr']*df$store_nbr + 
      coefs['item_nbr']*df$item_nbr + 
      coefs['date']*as.integer(df$date) + 
      coefs['(Intercept)']
  } else {
      df = NULL
  }
  df   # return df
})
```

```{r}
## construct traiing data
#train_set.df = train.df %>%
#  group_by(store_nbr, item_nbr, date) %>%
#  summarize(total_sales = sum(unit_sales))

## build the model
#fit = lm(total_sales ~ store_nbr + item_nbr + date, data=train_set.df)
```

## Column 1

### Predicted Data

```{r predict-data}
DT::renderDataTable({
  df = predicted.df()
  DT::datatable(df, 
                options = list(
                bPaginate = FALSE,
                scrollY = "80vh",
                dom = 't'))
})
```

## Column 2

### Total Sales Predicted

```{r total-predicted}
flexdashboard::renderValueBox({
  df = predicted.df()
  value_text = formatC(sum(df$total_sales),digits=0,format="f")
  flexdashboard::valueBox( value=value_text, icon = "fa-bar-chart", color='warning')
})
```

### Sales Estimation Over Time

```{r predicted-chart}
renderPlot({
  df = predicted.df()
  if (!is.null(df)) {
    ggplot(df, aes(x=date, y=total_sales)) + geom_bar(stat='identity') +  
    labs(title='Total Sales', x='Dates', y='Sales') +
    theme(axis.text.x  = element_text (angle = (90), hjust = 1, vjust = 0.5))
  }
})
```

## Selection {.sidebar}

```{r sidebar}
selectInput("select_store", h4("Store Number"),stores.df$store_nbr)
selectInput("select_item", h4("Item Number"),items.df$item_nbr)
dateRangeInput("date_range", h4("Date Range"))  
``` 
